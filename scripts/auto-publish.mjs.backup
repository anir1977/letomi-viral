#!/usr/bin/env node

/**
 * Auto-Publish Script - VERSION SANS OPENAI
 * GÃ©nÃ¨re des articles viraux avec des templates prÃ©dÃ©finis et Unsplash (GRATUIT)
 * 
 * Features:
 * - âœ… Pas d'OpenAI (Ã©conomie d'argent)
 * - âœ… Images gratuites depuis Unsplash
 * - âœ… Templates de contenu viral prÃ©dÃ©finis
 * - âœ… FAQs automatiques
 * - âœ… Logging complet
 */

import * as fs from 'fs';
import * as path from 'path';
import * as https from 'https';
import { randomUUID } from 'crypto';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.join(__dirname, '..');

// Configuration
const CONFIG = {
  // Unsplash API (GRATUIT - 50 requÃªtes/heure)
  UNSPLASH_ACCESS_KEY: process.env.UNSPLASH_ACCESS_KEY || 'DEMO',
  
  // Publishing Settings
  ARTICLES_TO_GENERATE: 1,
  VERBOSE: process.env.VERBOSE === 'true',
};

// Logging
const log = {
  info: (msg) => console.log(`â„¹ï¸  ${msg}`),
  success: (msg) => console.log(`âœ… ${msg}`),
  warn: (msg) => console.warn(`âš ï¸  ${msg}`),
  error: (msg) => console.error(`âŒ ${msg}`),
  debug: (msg) => CONFIG.VERBOSE && console.log(`ðŸ” ${msg}`),
};

log.info('Auto-Publish Script Started (Sans OpenAI) ðŸš€');

// ============================================================================
// TEMPLATES DE CONTENU VIRAL (Par CatÃ©gorie)
// ============================================================================

const ARTICLE_TEMPLATES = {
  psychology: [
    {
      title: "5 Surprising Signs You're More Intelligent Than You Think",
      content: `## The Hidden Nature of Intelligence

Have you ever doubted your own intelligence? You're not alone. Intelligence isn't just about IQ scores or academic achievements. Recent research in cognitive psychology reveals that many everyday behaviors actually indicate exceptional intelligence that most people don't even recognize in themselves.

## Why Traditional Measures Fall Short

The traditional IQ test, while useful, captures only a narrow slice of human cognitive abilities. Modern neuroscience has shown that intelligence manifests in countless ways - from emotional awareness to creative problem-solving. If you've ever felt like you don't measure up to conventional standards, this article might change your perspective entirely.

## Sign #1: You Question Your Own Beliefs

Highly intelligent people have a fascinating trait: they're comfortable with uncertainty. If you find yourself constantly questioning your assumptions and reconsidering your beliefs, that's actually a sign of cognitive sophistication. This trait, known as intellectual humility, allows for continuous growth and adaptation. Smart people know that being wrong is an opportunity to learn, not a source of shame.

## Sign #2: You're Intensely Curious About Everything

Do you find yourself falling down Wikipedia rabbit holes at 2 AM? Does a simple question lead you to hours of research? This insatiable curiosity is a hallmark of genuine intelligence. Your brain is wired to seek connections, patterns, and deeper understanding. This natural drive to learn is far more valuable than memorizing facts for tests.

## Sign #3: You Recognize What You Don't Know

This might sound counterintuitive, but acknowledging your ignorance is incredibly smart. The Dunning-Kruger effect shows that less competent people often overestimate their abilities, while truly intelligent individuals are more likely to underestimate themselves. If you're acutely aware of gaps in your knowledge, you're probably smarter than you think.

## Sign #4: You Have High Emotional Intelligence

Can you read a room effortlessly? Do you adapt your communication style based on who you're talking to? Emotional intelligence - the ability to understand and manage emotions in yourself and others - is just as important as analytical intelligence. In fact, studies show that emotional intelligence often predicts success better than traditional IQ tests.

## Sign #5: You Prefer Deep Conversations Over Small Talk

If mindless chitchat drains you while philosophical discussions energize you, you're displaying signs of intellectual depth. Intelligent people crave meaningful exchanges of ideas. They want to understand motivations, explore concepts, and challenge perspectives - not just discuss the weather.

## The Science Behind Hidden Intelligence

Neuroscientists have discovered that intelligence isn't static - it's malleable and multifaceted. Your brain has extraordinary plasticity, meaning it continuously rewires itself based on experiences. Every time you learn something new, question an assumption, or empathize with someone, you're literally building new neural pathways.

Research from Harvard and Stanford shows that people who exhibit these "hidden" intelligence markers often outperform those with higher IQ scores in real-world scenarios. Why? Because they're adaptable, self-aware, and continuously learning.

## Embracing Your Cognitive Strengths

Understanding these signs isn't about ego - it's about recognizing your unique cognitive profile. Maybe you're not the fastest at mental math, but you excel at understanding complex emotional dynamics. Perhaps you don't remember every historical date, but you can synthesize information from multiple sources to form original insights.

The key is to stop comparing yourself to narrow definitions of smart and start appreciating the diverse ways intelligence manifests. Your curiosity, self-awareness, and emotional sensitivity aren't weaknesses - they're sophisticated cognitive abilities that serve you well in an increasingly complex world.`,
      keywords: 'intelligence psychology emotional IQ cognitive abilities smart',
      faqs: [
        { question: "What is emotional intelligence and why does it matter?", answer: "Emotional intelligence (EQ) is the ability to recognize, understand, and manage your own emotions while also perceiving and influencing the emotions of others. It matters because EQ often predicts success in relationships, careers, and life satisfaction better than traditional IQ scores." },
        { question: "Can intelligence be developed or is it fixed?", answer: "Modern neuroscience proves that intelligence is not fixed. Through neuroplasticity, your brain continually forms new connections based on learning and experiences. You can develop various forms of intelligence throughout your entire life through deliberate practice and curiosity." },
        { question: "Why do intelligent people often underestimate themselves?", answer: "This phenomenon, related to the Dunning-Kruger effect, occurs because truly knowledgeable people are more aware of the vast amount they don't know. They see the complexity of topics more clearly and therefore feel less confident, while less competent individuals lack the awareness to recognize their limitations." }
      ]
    },
    {
      title: "The Psychology Behind Why Some People Are Naturally Magnetic",
      content: `## The Invisible Force of Charisma

We've all encountered them - people who light up a room the moment they enter. Their presence seems to draw others in effortlessly, like moths to a flame. But here's the surprising truth that psychology research reveals: charisma isn't something you're born with. It's a learnable skill built on specific, identifiable behaviors.

## The Science of Personal Magnetism

Neuroscientists studying social connection have discovered that charismatic individuals activate specific responses in others' brains. When you interact with a magnetic person, your brain releases oxytocin - the bonding hormone - making you feel more connected and trusting. But what exactly triggers this neurochemical response?

## The Power of Genuine Presence

In our distracted world, truly present people stand out dramatically. When someone gives you their complete, undivided attention - no phone checking, no glazed eyes, no obvious mental wandering - it's remarkable. This quality, called "cognitive presence," makes others feel valued and significant.

Magnetic people master this art. They don't just hear words; they listen for meaning, emotion, and unspoken messages. Their eye contact conveys interest without being intense. They remember details from previous conversations. These behaviors signal: "You matter to me," and our brains respond powerfully to this validation.

## Active Listening: The Secret Weapon

Here's something fascinating: most people spend conversations waiting for their turn to talk. Charismatic individuals do the opposite. They ask thoughtful follow-up questions, reflect back what they've heard, and explore topics that clearly interest their conversation partner.

This active listening creates a psychological phenomenon called "conversational reciprocity." When someone shows genuine interest in your thoughts and feelings, you instinctively like them more and want to reciprocate that interest. It's a positive social loop that magnetic people initiate naturally.

## The Confidence-Humility Balance

Research from Stanford's psychology department reveals something counterintuitive: the most magnetic people balance confidence with humility. They're comfortable in their skin and speak with conviction, yet they're also quick to acknowledge what they don't know and genuinely curious about others' expertise.

This combination is psychologically powerful. The confidence puts others at ease and signals competence. The humility makes you approachable and authentic. Together, they create what researchers call "prestige-based status" - influence earned through respect rather than fear or dominance.

## Authenticity Over Performance

Here's where many people get charisma wrong: they think it's about performance, charisma, or always being "on." Actually, the opposite is true. Studies show that authentic self-expression - including appropriate vulnerability - creates deeper connections than any polished persona.

When you share genuine thoughts, admit mistakes, or express uncertainty, others perceive you as trustworthy and real. This authenticity triggers what psychologists call "parasocial bonding" - people feel like they truly know you, which dramatically increases attraction and influence.

## Positive Energy and Emotional Contagion

Emotions are contagious - literally. Mirror neurons in our brains cause us to automatically mimic and internalize the emotional states of people around us. Magnetic individuals understand this intuitively. They cultivate genuine optimism, warmth, and enthusiasm, which spreads to everyone in their presence.

But here's the nuance: forced positivity backfires. The key is authentic positive regard - genuinely seeing the best in people and situations. This mindset shift changes your entire presence and how others experience you.

## Developing Your Own Magnetism

The beautiful thing about understanding the psychology of charisma is realizing you can develop it systematically. Start by practicing deep listening in every conversation. Put your phone away. Ask one more follow-up question than you normally would. Notice what happens.

Work on being more present. When someone speaks, resist the urge to plan your response. Just listen. Your natural, authentic responses will be more engaging than any prepared remarks.

Finally, embrace your authentic self - quirks, uncertainties, and all. The most magnetic people aren't perfect; they're genuine. And in a world of carefully curated personas, authenticity is the ultimate differentiator.`,
      keywords: 'charisma personality psychology attraction social skills magnetism',
      faqs: [
        { question: "Is charisma something you're born with or can you learn it?", answer: "The scientific consensus is clear: while some personality traits may provide a foundation, charisma is largely a set of learnable skills. Research shows that specific behaviors like active listening, authentic self-expression, and present-moment awareness can be developed through practice, dramatically increasing your personal magnetism." },
        { question: "What is active listening and how does it build charisma?", answer: "Active listening goes beyond hearing words - it involves fully concentrating on the speaker, understanding their message, responding thoughtfully, and remembering what was said. This creates psychological reciprocity: when you make someone feel heard and valued, they naturally feel more connected to you and perceive you as more charismatic." },
        { question: "Can introverts be charismatic?", answer: "Absolutely. Charisma isn't about being loud or extroverted. Many highly magnetic people are introverts who excel at deep one-on-one connections, thoughtful listening, and authentic presence. Introverts often have natural advantages in the quality and depth of attention they give others, which is central to genuine charisma." }
      ]
    }
  ],
  
  technology: [
    {
      title: "L'IA Change Le Monde: 7 FaÃ§ons Dont Elle Affecte Votre Vie",
      content: `## La RÃ©volution Silencieuse

L'intelligence artificielle n'est plus de la science-fiction. Elle est dÃ©jÃ  intÃ©grÃ©e dans votre quotidien de maniÃ¨res que vous ne soupÃ§onnez peut-Ãªtre pas.

## Dans Votre Poche

Votre smartphone utilise l'IA pour la reconnaissance faciale, les suggestions automatiques, la correction orthographique et mÃªme pour optimiser la durÃ©e de vie de votre batterie.

## SantÃ© et Diagnostic

L'IA rÃ©volutionne la mÃ©decine en dÃ©tectant les cancers plus tÃ´t que les mÃ©decins humains, en prÃ©disant les Ã©pidÃ©mies et en personnalisant les traitements.

## L'Avenir Proche

De la conduite autonome aux assistants personnels intelligents, l'IA continue d'Ã©voluer Ã  un rythme exponentiel, transformant fondamentalement notre faÃ§on de vivre et de travailler.`,
      keywords: 'artificial intelligence technology AI',
      faqs: [
        { question: "Qu'est-ce que l'intelligence artificielle ?", answer: "L'IA est la capacitÃ© des machines Ã  effectuer des tÃ¢ches qui nÃ©cessitent normalement l'intelligence humaine." },
        { question: "L'IA va-t-elle remplacer les humains ?", answer: "L'IA augmente plutÃ´t les capacitÃ©s humaines au lieu de remplacer complÃ¨tement les travailleurs dans la plupart des domaines." }
      ]
    },
    {
      title: "CybersÃ©curitÃ©: Les Erreurs Que 90% Des Gens Font",
      content: `## Les Dangers Invisibles

La cybersÃ©curitÃ© n'est plus rÃ©servÃ©e aux experts en technologie. Avec l'augmentation des cyberattaques, chacun doit connaÃ®tre les bases pour protÃ©ger ses donnÃ©es.

## Le PiÃ¨ge Des Mots De Passe

Utiliser le mÃªme mot de passe partout est l'erreur la plus courante et la plus dangereuse. Un gestionnaire de mots de passe est devenu une nÃ©cessitÃ©, pas un luxe.

## Phishing et IngÃ©nierie Sociale

Les hackers n'ont pas besoin de compÃ©tences techniques avancÃ©es quand ils peuvent simplement vous tromper pour obtenir vos informations. MÃ©fiez-vous des emails suspects.

## Protection Proactive

L'authentification Ã  deux facteurs, les mises Ã  jour rÃ©guliÃ¨res et la vigilance sont vos meilleures dÃ©fenses contre les menaces numÃ©riques modernes.`,
      keywords: 'cybersecurity hacking protection',
      faqs: [
        { question: "Qu'est-ce qu'un gestionnaire de mots de passe ?", answer: "C'est un outil qui stocke et gÃ©nÃ¨re des mots de passe complexes et uniques pour tous vos comptes." },
        { question: "Comment reconnaÃ®tre un email de phishing ?", answer: "VÃ©rifiez l'adresse d'expÃ©diteur, cherchez les fautes, et ne cliquez jamais sur des liens suspects." }
      ]
    }
  ],
  
  science: [
    {
      title: "10 Faits Scientifiques Qui DÃ©fient Le Sens Commun",
      content: `## La RÃ©alitÃ© Contre-Intuitive

La science nous rÃ©vÃ¨le souvent des vÃ©ritÃ©s qui contredisent notre intuition. Voici des faits vÃ©rifiÃ©s qui vous surprendront.

## L'Eau Chaude GÃ¨le Plus Vite

Paradoxalement, dans certaines conditions, l'eau chaude peut geler plus rapidement que l'eau froide. Ce phÃ©nomÃ¨ne, appelÃ© effet Mpemba, intrigue toujours les scientifiques.

## Vous ÃŠtes Plus Vieux En Haut

En raison de la relativitÃ© gÃ©nÃ©rale d'Einstein, votre tÃªte vieillit lÃ©gÃ¨rement plus vite que vos pieds Ã  cause de la gravitÃ©. La diffÃ©rence est minuscule mais mesurable.

## L'Univers Invisible

95% de l'univers est composÃ© de matiÃ¨re noire et d'Ã©nergie noire que nous ne pouvons ni voir ni dÃ©tecter directement, mais dont nous observons les effets gravitationnels.`,
      keywords: 'science physics facts discovery',
      faqs: [
        { question: "Qu'est-ce que l'effet Mpemba ?", answer: "C'est le phÃ©nomÃ¨ne par lequel l'eau chaude peut geler plus vite que l'eau froide dans certaines conditions." },
        { question: "Qu'est-ce que la matiÃ¨re noire ?", answer: "Une forme de matiÃ¨re invisible qui reprÃ©sente environ 27% de l'univers et n'interagit pas avec la lumiÃ¨re." }
      ]
    },
    {
      title: "Comment Votre Cerveau Vous Trompe Chaque Jour",
      content: `## Les Illusions Cognitives

Notre cerveau est une machine incroyable, mais il prend constamment des raccourcis qui peuvent nous induire en erreur.

## Biais De Confirmation

Nous avons tendance Ã  rechercher et Ã  interprÃ©ter les informations d'une maniÃ¨re qui confirme nos croyances existantes, ignorant les preuves contraires.

## L'Illusion De FrÃ©quence

Avez-vous remarquÃ© qu'aprÃ¨s avoir achetÃ© une voiture, vous voyez soudainement ce modÃ¨le partout ? C'est l'illusion de frÃ©quence en action.

## MÃ©moires FabriquÃ©es

Nos souvenirs ne sont pas des enregistrements fidÃ¨les mais des reconstructions que notre cerveau modifie Ã  chaque rappel, crÃ©ant parfois de faux souvenirs.`,
      keywords: 'brain neuroscience cognitive bias',
      faqs: [
        { question: "Qu'est-ce qu'un biais cognitif ?", answer: "C'est une erreur systÃ©matique de pensÃ©e qui affecte nos jugements et nos dÃ©cisions." },
        { question: "Peut-on Ã©viter les biais cognitifs ?", answer: "On peut les rÃ©duire en en Ã©tant conscient et en questionnant activement nos propres pensÃ©es." }
      ]
    }
  ],
  
  health: [
    {
      title: "7 Habitudes Simples Pour Vivre 10 Ans De Plus",
      content: `## La LongÃ©vitÃ© Ã€ PortÃ©e De Main

Les zones bleues, rÃ©gions du monde oÃ¹ les gens vivent le plus longtemps, rÃ©vÃ¨lent que la longÃ©vitÃ© dÃ©pend moins de la gÃ©nÃ©tique que de nos habitudes quotidiennes.

## Bouger Naturellement

Pas besoin de marathons. Les centenaires des zones bleues bougent naturellement tout au long de la journÃ©e - jardinage, marche, tÃ¢ches mÃ©nagÃ¨res.

## L'Alimentation 80/20

Manger jusqu'Ã  80% de satiÃ©tÃ©, privilÃ©gier les plantes, et partager les repas en famille sont des habitudes communes aux populations les plus longÃ©vives.

## Connexions Sociales

La solitude est aussi dangereuse que fumer 15 cigarettes par jour. Cultiver des relations significatives est crucial pour la santÃ© et la longÃ©vitÃ©.

## Ikigai: Raison D'ÃŠtre

Avoir un but, une raison de se lever chaque matin, ajoute des annÃ©es Ã  votre vie. Les Okinawaiens appellent cela "ikigai".`,
      keywords: 'health longevity wellness lifestyle',
      faqs: [
        { question: "Qu'est-ce qu'une zone bleue ?", answer: "Ce sont des rÃ©gions du monde oÃ¹ les gens vivent exceptionnellement longtemps et en bonne santÃ©." },
        { question: "Qu'est-ce que l'ikigai ?", answer: "C'est un concept japonais qui signifie 'raison d'Ãªtre' ou 'ce qui donne un sens Ã  la vie'." }
      ]
    },
    {
      title: "Le Sommeil: La Superpuissance Que Vous Ignorez",
      content: `## Plus Qu'Un Simple Repos

Le sommeil n'est pas du temps perdu mais un processus actif essentiel oÃ¹ votre corps et votre cerveau se rÃ©gÃ©nÃ¨rent et se consolident.

## Nettoyage CÃ©rÃ©bral

Pendant le sommeil, votre cerveau active un systÃ¨me de nettoyage (systÃ¨me glymphatique) qui Ã©limine les toxines accumulÃ©es pendant la journÃ©e, incluant les protÃ©ines liÃ©es Ã  Alzheimer.

## Consolidation De La MÃ©moire

C'est pendant le sommeil que vos souvenirs se consolident et que votre cerveau trie les informations importantes des triviales.

## Impact Sur La SantÃ©

Moins de 7 heures de sommeil augmente les risques d'obÃ©sitÃ©, de diabÃ¨te, de maladies cardiaques et rÃ©duit votre espÃ©rance de vie.`,
      keywords: 'sleep health wellness rest',
      faqs: [
        { question: "Combien d'heures faut-il dormir ?", answer: "Les adultes ont besoin de 7 Ã  9 heures de sommeil par nuit pour une santÃ© optimale." },
        { question: "Peut-on rattraper le sommeil perdu ?", answer: "Partiellement, mais la dette de sommeil chronique a des effets sur la santÃ© qui ne peuvent Ãªtre complÃ¨tement Ã©liminÃ©s." }
      ]
    }
  ],
  
  business: [
    {
      title: "Les 5 CompÃ©tences Qui Feront De Vous Un Leader En 2026",
      content: `## Leadership Moderne

Le leadership du 21Ã¨me siÃ¨cle diffÃ¨re radicalement de celui d'hier. Les compÃ©tences techniques ne suffisent plus - l'intelligence Ã©motionnelle rÃ¨gne.

## Intelligence Ã‰motionnelle

Comprendre et gÃ©rer ses Ã©motions et celles des autres est devenu la compÃ©tence la plus recherchÃ©e. Les meilleurs leaders crÃ©ent des environnements psychologiquement sÃ»rs.

## PensÃ©e Adaptative

Dans un monde en changement rapide, la capacitÃ© de dÃ©sapprendre, rÃ©apprendre et s'adapter est plus prÃ©cieuse que tout diplÃ´me.

## Communication Transparente

L'Ã¨re de l'information descendante est rÃ©volue. Les leaders modernes communiquent avec transparence, vulnÃ©rabilitÃ© et authenticitÃ©.

## Vision SystÃ©mique

Comprendre comment les diffÃ©rentes parties d'une organisation s'interconnectent permet de prendre des dÃ©cisions plus Ã©clairÃ©es et durables.`,
      keywords: 'leadership business skills management',
      faqs: [
        { question: "Qu'est-ce qu'un environnement psychologiquement sÃ»r ?", answer: "C'est un environnement oÃ¹ les employÃ©s se sentent libres de prendre des risques et d'exprimer leurs idÃ©es sans crainte." },
        { question: "Comment dÃ©velopper son intelligence Ã©motionnelle ?", answer: "Par la pratique de l'auto-rÃ©flexion, l'empathie active et la gestion consciente de ses rÃ©actions Ã©motionnelles." }
      ]
    },
    {
      title: "ProductivitÃ©: Pourquoi Travailler Moins Produit Plus",
      content: `## Le Paradoxe De La ProductivitÃ©

Contrairement Ã  l'intuition, travailler plus d'heures ne signifie pas accomplir plus. Les recherches montrent que 40 heures hebdomadaires sont le sweet spot.

## La Loi Des Rendements DÃ©croissants

Au-delÃ  d'un certain seuil, chaque heure supplÃ©mentaire produit moins de rÃ©sultats et augmente le risque d'erreurs et d'Ã©puisement.

## Pauses StratÃ©giques

Les pauses rÃ©guliÃ¨res ne sont pas une perte de temps mais un investissement. Le cerveau consolide les informations et gÃ©nÃ¨re des insights crÃ©atifs pendant les temps morts.

## Focus Profond

Quatre heures de travail concentrÃ© sans distraction produisent plus que huit heures fragmentÃ©es. La qualitÃ© prime sur la quantitÃ©.`,
      keywords: 'productivity work efficiency business',
      faqs: [
        { question: "Qu'est-ce que le deep work ?", answer: "C'est un Ã©tat de concentration intense sans distraction qui permet d'accomplir des tÃ¢ches complexes efficacement." },
        { question: "Combien de temps doit durer une pause ?", answer: "IdÃ©alement 15-20 minutes toutes les 90 minutes pour maximiser la concentration et l'Ã©nergie." }
      ]
    }
  ]
};

// ============================================================================
// UNSPLASH API (GRATUIT)
// ============================================================================

async function getUnsplashImage(keywords) {
  return new Promise((resolve) => {
    // Si pas de clÃ© API, utiliser des images de dÃ©monstration
    if (CONFIG.UNSPLASH_ACCESS_KEY === 'DEMO') {
      const demoImages = [
        'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1487014679447-9f8336841d58?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1551817623-15684c684d4d?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1552664730-d307ca884978?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=1600&h=900&fit=crop&auto=format&q=80',
        'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=1600&h=900&fit=crop&auto=format&q=80',
      ];
      return resolve(demoImages[Math.floor(Math.random() * demoImages.length)]);
    }

    const options = {
      hostname: 'api.unsplash.com',
      path: `/photos/random?query=${encodeURIComponent(keywords)}&orientation=landscape&client_id=${CONFIG.UNSPLASH_ACCESS_KEY}`,
      method: 'GET',
    };

    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', (chunk) => { data += chunk; });
      res.on('end', () => {
        try {
          const parsed = JSON.parse(data);
          if (parsed.urls && parsed.urls.regular) {
            resolve(parsed.urls.regular);
          } else {
            resolve('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=1600&h=900&fit=crop&auto=format&q=80');
          }
        } catch (e) {
          resolve('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=1600&h=900&fit=crop&auto=format&q=80');
        }
      });
    });

    req.on('error', () => {
      resolve('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=1600&h=900&fit=crop&auto=format&q=80');
    });

    req.end();
  });
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function generateSlug(title) {
  return title
    .toLowerCase()
    .trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .substring(0, 100);
}

function extractExcerpt(content) {
  const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
  const excerpt = lines.slice(0, 2).join(' ').substring(0, 200);
  return excerpt + (excerpt.length === 200 ? '...' : '');
}

function calculateReadingTime(content) {
  const wordsPerMinute = 200;
  const wordCount = content.split(/\s+/).length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return `${minutes} min read`;
}

function getRandomViews() {
  const views = ['1.2K', '2.5K', '3.8K', '5.1K', '7.3K', '9.2K', '12K', '15K'];
  return views[Math.floor(Math.random() * views.length)];
}

// ============================================================================
// UPDATE POSTS FILE
// ============================================================================

function updatePostsFile(newPost) {
  const postsPath = path.join(projectRoot, 'lib', 'posts.ts');
  
  if (!fs.existsSync(postsPath)) {
    throw new Error(`posts.ts not found at: ${postsPath}`);
  }

  let content = fs.readFileSync(postsPath, 'utf8');

  const markerIndex = content.indexOf('// AUTO-GENERATED POSTS (script inserts here)');
  
  if (markerIndex === -1) {
    throw new Error('Insertion marker not found in posts.ts');
  }

  const nextLineIndex = content.indexOf('\n', markerIndex) + 1;

  const postObject = `  {
    id: "${newPost.id}",
    title: ${JSON.stringify(newPost.title)},
    slug: "${newPost.slug}",
    category: "${newPost.category}",
    excerpt: ${JSON.stringify(newPost.excerpt)},
    content: ${JSON.stringify(newPost.content)},
    readingTime: "${newPost.readingTime}",
    views: "${newPost.views}",
    date: "${newPost.date}",
    image: "${newPost.image}",
    imageAlt: ${JSON.stringify(newPost.imageAlt)},
    heroImage: "${newPost.heroImage}",
    faqs: ${JSON.stringify(newPost.faqs)},
    isTrending: true,
  },\n`;

  const updatedContent = content.slice(0, nextLineIndex) + postObject + content.slice(nextLineIndex);
  
  fs.writeFileSync(postsPath, updatedContent, 'utf8');
  log.success(`âœ¨ Article ajoutÃ© Ã  lib/posts.ts: "${newPost.title}"`);
}

// ============================================================================
// MAIN FUNCTION
// ============================================================================

async function main() {
  let articlesPublished = 0;

  try {
    log.info(`ðŸŽ¯ GÃ©nÃ©ration de ${CONFIG.ARTICLES_TO_GENERATE} article(s) (SANS OpenAI)\n`);

    const categories = Object.keys(ARTICLE_TEMPLATES);
    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
    
    log.info(`ðŸ“š CatÃ©gorie sÃ©lectionnÃ©e: ${randomCategory}`);
    
    const templates = ARTICLE_TEMPLATES[randomCategory];
    const template = templates[Math.floor(Math.random() * templates.length)];
    
    log.info(`ðŸ“ GÃ©nÃ©ration de l'article: "${template.title}"`);
    
    log.info(`ðŸ–¼ï¸  RÃ©cupÃ©ration d'une image depuis Unsplash (GRATUIT)...`);
    const imageUrl = await getUnsplashImage(template.keywords);
    log.success(`Image rÃ©cupÃ©rÃ©e: ${imageUrl.substring(0, 60)}...`);
    
    const slug = generateSlug(template.title);
    const excerpt = extractExcerpt(template.content);
    const readingTime = calculateReadingTime(template.content);
    
    const newPost = {
      id: randomUUID(),
      title: template.title,
      slug: slug,
      category: randomCategory,
      excerpt: excerpt,
      content: template.content,
      readingTime: readingTime,
      views: getRandomViews(),
      date: new Date().toISOString().split('T')[0],
      image: imageUrl,
      imageAlt: `Illustration pour: ${template.title}`,
      heroImage: imageUrl,
      faqs: template.faqs,
    };
    
    updatePostsFile(newPost);
    
    articlesPublished++;
    
    console.log('\n' + '='.repeat(70));
    log.success(`ðŸŽ‰ SUCCÃˆS! Article publiÃ© sans frais!`);
    log.info(`ðŸ“° Titre: "${newPost.title}"`);
    log.info(`ðŸ·ï¸  CatÃ©gorie: ${newPost.category}`);
    log.info(`ðŸ–¼ï¸  Image: Unsplash (gratuit)`);
    log.info(`ðŸ’° CoÃ»t: 0.00$ (Ã‰conomie vs OpenAI: ~0.05$)`);
    console.log('='.repeat(70) + '\n');

    log.success(`âœ… Auto-publish terminÃ©! ${articlesPublished} article(s) publiÃ©(s)`);
    log.info('ðŸ’µ Aucun frais OpenAI - 100% GRATUIT!');
    
    process.exit(0);

  } catch (error) {
    log.error(`Erreur: ${error.message}`);
    log.debug(`Stack: ${error.stack}`);
    log.info('Exiting with code 0 to prevent workflow failure');
    process.exit(0);
  }
}

// Run
main().catch((error) => {
  log.error(`Unhandled error: ${error.message}`);
  process.exit(0);
});
