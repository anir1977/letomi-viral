<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test API Supabase - Diagnostic</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
    pre { background: #000; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ” Diagnostic API Supabase</h1>
  <div id="output"></div>

  <script type="module">
    const output = document.getElementById('output');
    
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = msg;
      output.appendChild(div);
    }

    async function testSupabase() {
      log('ğŸš€ DÃ©marrage du test...', 'warning');
      
      // Import Supabase
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      
      const supabaseUrl = 'https://lbyrkhqnhkmwywhwtlwe.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxieXJraHFuaGttd3l3aHd0bHdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczOTQwNjgsImV4cCI6MjA1Mjk3MDA2OH0.dKT8FmrCLr_Z1K3PvQN_lQOgWQqLk4iDCzHPYkqRFE8';
      
      const supabase = createClient(supabaseUrl, supabaseKey);
      
      log('âœ… Client Supabase crÃ©Ã©', 'success');
      
      // Test 1: Lecture simple
      log('\nğŸ“– Test 1: SELECT avec category_id');
      const { data: articles, error: selectError } = await supabase
        .from('articles')
        .select('id, title, category_id')
        .limit(1);
      
      if (selectError) {
        log(`âŒ ERREUR SELECT: ${selectError.message}`, 'error');
        log(JSON.stringify(selectError, null, 2), 'error');
      } else {
        log(`âœ… SELECT OK - ${articles.length} articles`, 'success');
        log(JSON.stringify(articles[0], null, 2), 'success');
      }
      
      // Test 2: Insertion SANS category_id
      log('\nğŸ“ Test 2: INSERT sans category_id');
      const testData = {
        title: 'Test Diagnostic ' + Date.now(),
        slug: 'test-' + Date.now(),
        content: 'Test content',
        excerpt: 'Test excerpt',
        status: 'draft'
        // PAS de category_id !
      };
      
      log('Payload: ' + JSON.stringify(testData, null, 2), 'warning');
      
      const { data: inserted, error: insertError } = await supabase
        .from('articles')
        .insert(testData)
        .select();
      
      if (insertError) {
        log(`âŒ ERREUR INSERT: ${insertError.message}`, 'error');
        log(JSON.stringify(insertError, null, 2), 'error');
      } else {
        log(`âœ… INSERT OK!`, 'success');
        log(JSON.stringify(inserted, null, 2), 'success');
        
        // Nettoyage
        await supabase.from('articles').delete().eq('id', inserted[0].id);
        log('ğŸ—‘ï¸ Article de test supprimÃ©', 'warning');
      }
    }
    
    testSupabase().catch(e => log(`ğŸ’¥ Erreur globale: ${e.message}`, 'error'));
  </script>
</body>
</html>
